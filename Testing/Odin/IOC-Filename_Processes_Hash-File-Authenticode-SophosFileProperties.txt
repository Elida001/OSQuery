/*****************************************************************************************\
| This query will collect details on running processes where you specifiy a filename to   |
| search. It will look at the process name, path and cmdline for an exact match. You can  |
| add wildcards.                                                                          |
| Additional data from hash, file, authenticode, sophos file properties.                  |
|                                                                                         |
| Example:                                                                                |
| "svchost" will not return results                                                       |
| "svchost.exe" will only return processes with that exatc name                           |
| "svchost%" will return all running svchost.exe processes                                |
| "%svchost%" will return the above, plus any running process that has svchost in the     |
| path or cmdline.                                                                        |
|                                                                                         |
| Version: 1.0                                                                            |
| Author: @AltShiftPrtScn                                                                 |
| github.com/SophosRapidResponse                                                          |
\*****************************************************************************************/

SELECT
p.name AS Name,
p.path AS Path,
p.cmdline AS CMDLine,
p.pid AS PID,
p.parent AS Parent_PID,
CASE 
WHEN p.on_disk = 1 THEN 'Yes'
WHEN p.on_disk = 0 THEN 'No'
WHEN p.on_disk = -1 THEN 'Unknown'
END AS On_Disk,
strftime('%Y-%m-%dT%H:%M:%SZ',datetime(start_time,'unixepoch')) AS 'Start_Time',
'Running_Processes' AS Data_Source,
h.md5 AS MD5,
h.sha1 AS SHA1,
h.sha256 AS SHA256,
a.original_program_name AS Cert_Original_Program_Name,
a.serial_number AS Cert_Serial_Number,
a.issuer_name AS Cert_Issuer_name,
a.subject_name AS Cert_Subject_Name,
a.result AS Cert_Result,
f.size AS File_Size,
f.attributes AS File_Attributes,
f.file_version AS File_Version,
sfp.ml_score AS ML_Score,
sfp.pua_score AS PUA_Score,
sfp.local_rep AS Local_Reputation,
sfp.global_rep AS Global_Reputation,
'|' AS 'Meta_data',
CAST ( (Select customer_id from sophos_endpoint_info) AS text) Customer_ID,
CAST ( (Select endpoint_id from sophos_endpoint_info) AS text) Endpoint_ID,
CAST ( (Select datetime from time) AS text) Request_Timestamp,
'$$Analyst$$' AS Analyst,
'Filename' AS IOC_Type,
'$$IOC$$' AS Search_String
FROM processes p
JOIN hash h ON p.path = h.path
JOIN authenticode a ON p.path = a.path
JOIN file f ON p.path = f.path
JOIN sophos_file_properties sfp ON p.path = sfp.path
WHERE (p.name LIKE '$$IOC$$' OR p.path LIKE '$$IOC$$' OR p.cmdline LIKE '$$IOC$$')