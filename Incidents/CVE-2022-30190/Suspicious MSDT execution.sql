/*********************************************** Sophos.com/RapidResponse *******************************************\
| DESCRIPTION                                                                                                         |
| The query look for evidence suspicious arguments passed to the msdt.exe process. These arguments are an indicator of|
| recent Office/Msdt exploitation - CVE-2022-30190                                                                    |
|                                                                                                                     |
| Reference:                                                                                                          |
| https://news.sophos.com/en-us/2022/05/30/malicious-word-doc-taps-previously-unknown-microsoft-office-vulnerability/ |
|                                                                                                                     |
| Version: 1.0                                                                                                        |
| Author: The Rapid Response Team| Elida Leite                                                                        |
| github.com/SophosRapidResponse                                                                                      |
\*********************************************************************************************************************/

SELECT 
    strftime('%Y-%m-%dT%H:%M:%SZ',datetime(spj.process_start_time,'unixepoch')) AS Datetime,
    spj.cmd_line AS Cmd_line,
    CAST (spj.process_name AS TEXT) Process_name,
    spj.sophos_pid AS sophos_PID,
    spj.path AS Path, 
    strftime('%Y-%m-%dT%H:%M:%SZ',datetime(spj.process_start_time,'unixepoch')) AS Process_start_time, 
    CASE WHEN spj.end_time = 0 THEN '' ELSE strftime('%Y-%m-%dT%H:%M:%SZ',datetime(spj.end_time,'unixepoch')) END AS Process_end_time, 
    CAST ( (Select u.username from users u where spj.sid = u.uuid) AS text) Username,
    spj.sid AS Sid,
    spj.parent_sophos_pid AS sophos_parent_PID,
    CAST ( (Select spj2.process_name from sophos_process_journal spj2 where spj2.sophos_pid = spj.parent_sophos_pid) AS text) Parent_process,
    CAST ( (Select spj2.cmd_line from sophos_process_journal spj2 where spj2.sophos_pid = spj.parent_sophos_pid) AS text) Parent_cmd_line,
    'Process Journal/Users' AS Data_Source,
    'Suspicious MSDT execution' AS Query 
FROM sophos_process_journal spj 
WHERE (Process_name IN ('msdt.exe') AND (spj.cmd_line LIKE '%ms-msdt:/id%PCWDiagnostic%' OR spj.cmd_line LIKE '%ms-msdt:-id%PCWDiagnostic%'))
    OR (Process_name IN ('powershell.exe') AND (spj.cmd_line LIKE '%wget%.html%' OR spj.cmd_line LIKE '%Invoke-WebRequest%.html%'))
    AND spj.time > STRFTIME('%s','NOW','-15 DAYS')