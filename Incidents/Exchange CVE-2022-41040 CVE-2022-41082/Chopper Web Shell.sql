/*************************** Sophos.com/RapidResponse ***************************\
| DESCRIPTION                                                                    |
| Hunting for evidence of Chopper web shell using Sophos Journals                |
|                                                                                |
| VARIABLE                                                                       |
| - start_time (DATE) = SID of the user                                          |
| - end_time (DATE)                                                              |
|                                                                                |
| REFERENCE                                                                      |
| https://www.microsoft.com/security/blog/2022/09/30/analyzing-attacks-using-the-|
| exchange-vulnerabilities-cve-2022-41040-and-cve-2022-41082/                    |
|                                                                                |
| Version: 1.0                                                                   |
| Author: The Rapid Response Team                                                |
| github.com/SophosRapidResponse                                                 |
\********************************************************************************/


SELECT 
    strftime('%Y-%m-%dT%H:%M:%SZ',datetime(spj.process_start_time,'unixepoch')) AS process_start_time,
    spj.cmd_line AS cmd_line,
    spj.sophos_pid AS sophos_PID, 
    CAST (spj.process_name AS TEXT) process_name,
    CASE WHEN spj.end_time = 0 THEN '' ELSE strftime('%Y-%m-%dT%H:%M:%SZ',datetime(spj.end_time,'unixepoch')) END AS process_end_time, 
    CAST ( (Select u.username from users u where spj.sid = u.uuid) AS text) username,
    spj.sid AS sid,
    spj.parent_sophos_pid AS sophos_parent_PID, 
    CAST ( (Select spj2.process_name from sophos_process_journal spj2 where spj2.sophos_pid = spj.parent_sophos_pid) AS text) parent_process,
    CAST ( (Select spj2.cmd_line from sophos_process_journal spj2 where spj2.sophos_pid = spj.parent_sophos_pid) AS text) parent_cmd_line,
    'Process Journal/Users' AS Data_Source,
    'Chopper web shell' AS Query 
FROM sophos_process_journal spj 
WHERE process_name = 'w3wp.exe'
AND (cmd_line LIKE '%&ipconfig&echo%' 
    OR cmd_line LIKE '%&quser&echo%' 
    OR  cmd_line LIKE '%&whoami&echo%' 
    OR cmd_line LIKE '%&c:&echo%' 
    OR cmd_line LIKE '%&cd&echo%' 
    OR cmd_line LIKE '%&dir&echo%' 
    OR cmd_line LIKE '%&echo [E]%'
    OR cmd_line LIKE '%&echo [S]%')
AND spj.time >= $$start_time$$
AND spj.time <= $$end_time$$
GROUP BY sophos_PID