/*************************** Sophos.com/RapidResponse ***************************\
| REQUIRES SOPHOS JOURNALS                                                       |
|                                                                                |
| DESCRIPTION                                                                    |
| Use this to find processes that were spawned by Word, Excel or PowerShell.     |
|                                                                                |
| VARIABLE                                                                       |
| begin(date) = datetime of when to start hunting                                |
| end(date) = datetime of when to stop hunting                                   |
|                                                                                |
| Version: 1.0                                                                   |
| Author: @AltShiftPrtScn & Abhijit Gupta                                        |
| github.com/SophosRapidResponse                                                 |
\********************************************************************************/

SELECT
 spj.pathname AS Path, 
 spj.cmdline AS CMD_line,
 spj.sophosPID AS Sophos_PID, 
 spj.processName AS Process_Name,
 spj.sid AS SID,
 u.username AS Username,
 spj.parentSophosPid AS Sophos_Parent_PID, 
 CAST ( (Select spj2.pathname from sophos_process_journal spj2 where spj2.sophospid = spj.parentSophosPid) AS text) Parent_Path,
 CAST ( (Select spj2.processname from sophos_process_journal spj2 where spj2.sophospid = spj.parentSophosPid) AS text) Parent_Process_Name,
 'Process Journal/Users' AS Data_Source,
 'Process.04.0' AS Query
FROM sophos_process_journal spj 
JOIN users u ON swe.user_id = u.uuid
WHERE (Parent_Process_Name = 'WINWORD.EXE' OR Parent_Process_Name LIKE '%excel%' OR Parent_Process_Name LIKE '%powershell%')
AND (Process_Name != 'WINWORD.EXE' AND Process_Name != 'EXCEL.EXE')
AND spj.time >= CAST($$begin$$ AS INT) 
AND spj.time <= CAST($$end$$ AS INT)